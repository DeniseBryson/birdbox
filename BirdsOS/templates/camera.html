{% extends "base.html" %}

{% block title %}Camera{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Camera Feed</h5>
                    <div class="status-indicators">
                        <span id="fpsCounter" class="badge bg-info me-2">0 FPS</span>
                        <span id="motionIndicator" class="badge bg-secondary">No Motion</span>
                    </div>
                </div>
                <div class="card-body">
                    <div id="cameraSelectContainer" class="mb-3">
                        <select id="cameraSelect" class="form-select">
                            <option value="">Select a camera...</option>
                            {% for camera in cameras %}
                            <option value="{{ camera.id }}">{{ camera.name }} ({{ camera.resolution[0] }}x{{ camera.resolution[1] }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="video-container">
                        <div id="noCameraMessage" class="text-center p-5">
                            <h4>No Camera Selected</h4>
                            <p class="text-muted">Please select a camera from the dropdown above.</p>
                        </div>
                        <img id="cameraFeed" src="" class="img-fluid d-none" alt="Camera Feed">
                        <div id="recordingIndicator" class="recording-indicator d-none">
                            <span class="badge bg-danger">REC</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">Recording Controls</h5>
                </div>
                <div class="card-body">
                    <button id="startRecording" class="btn btn-primary mb-2 w-100" disabled>Start Recording</button>
                    <button id="stopRecording" class="btn btn-danger mb-2 w-100" disabled>Stop Recording</button>
                    <button id="stopCamera" class="btn btn-warning mb-2 w-100" disabled>Stop Camera</button>
                    <div class="recording-stats mt-2 d-none" id="recordingStats">
                        <small class="text-muted">
                            Duration: <span id="recordingDuration">0:00</span><br>
                            Frames: <span id="frameCount">0</span>
                        </small>
                    </div>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">Camera Settings</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="resolution" class="form-label">Resolution</label>
                        <select id="resolution" class="form-select mb-2" disabled>
                            <option value="640,480">640x480</option>
                            <option value="1280,720">1280x720</option>
                            <option value="1920,1080">1920x1080</option>
                        </select>
                    </div>
                    <button id="updateSettings" class="btn btn-secondary w-100" disabled>Update Settings</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Recent Recordings</h5>
                    <button class="btn btn-sm btn-outline-secondary" id="refreshRecordings">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div id="recordingsList" class="list-group">
                        <!-- Recordings will be populated here -->
                    </div>
                </div>
            </div>
            <div class="system-controls">
                <button id="updateButton" class="btn btn-primary">Update System</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables and functions
const API_BASE_URL = 'http://localhost:5001';  // Add base URL
let recordingsList;
let recordingStartTime = null;
let recordingInterval = null;
let selectedCamera = null;
let statusUpdateInterval = null;  // Add status update interval

// Load recordings function (globally accessible)
async function loadRecordings() {
    try {
        const response = await fetch(`${API_BASE_URL}/api/camera/recordings`);
        const data = await response.json();
        if (data.status === 'success') {
            const recordings = data.recordings || [];
            recordingsList.innerHTML = recordings.length === 0 ? 
                '<div class="text-center text-muted p-3">No recordings available</div>' :
                recordings.map(recording => `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${recording.timestamp}</h6>
                            <small>${recording.size}</small>
                        </div>
                        <p class="mb-1">Duration: ${recording.duration}</p>
                        <div class="btn-group btn-group-sm">
                            <a href="${API_BASE_URL}/api/camera/recordings/${recording.id}/download" class="btn btn-outline-primary">Download</a>
                            <button class="btn btn-outline-danger" onclick="deleteRecording('${recording.id}')">Delete</button>
                        </div>
                    </div>
                `).join('');
        } else {
            recordingsList.innerHTML = '<div class="text-center text-danger p-3">Failed to load recordings</div>';
        }
    } catch (error) {
        console.error('Error loading recordings:', error);
        recordingsList.innerHTML = '<div class="text-center text-danger p-3">Error loading recordings</div>';
    }
}

// Delete recording function (globally accessible)
async function deleteRecording(recordingId) {
    if (!confirm('Are you sure you want to delete this recording?')) {
        return;
    }
    try {
        const response = await fetch(`${API_BASE_URL}/api/camera/recordings/${recordingId}`, {
            method: 'DELETE'
        });
        const data = await response.json();
        if (data.status === 'success') {
            loadRecordings();  // Refresh the list
        } else {
            alert('Failed to delete recording');
        }
    } catch (error) {
        console.error('Error deleting recording:', error);
        alert('Error deleting recording');
    }
}

// Add status update function
async function updateCameraStatus() {
    if (!selectedCamera) return;
    
    try {
        const response = await fetch(`${API_BASE_URL}/api/camera/status`);
        const data = await response.json();
        
        // Update FPS counter
        const fpsCounter = document.getElementById('fpsCounter');
        fpsCounter.textContent = `${Math.round(data.fps)} FPS`;
        
        // Update motion indicator
        const motionIndicator = document.getElementById('motionIndicator');
        if (data.motion_detected) {
            motionIndicator.textContent = 'Motion Detected';
            motionIndicator.classList.remove('bg-secondary');
            motionIndicator.classList.add('bg-warning');
        } else {
            motionIndicator.textContent = 'No Motion';
            motionIndicator.classList.remove('bg-warning');
            motionIndicator.classList.add('bg-secondary');
        }
        
        // Update frame counter if recording
        if (data.is_recording) {
            document.getElementById('frameCount').textContent = data.frame_count;
        }
    } catch (error) {
        console.error('Error updating camera status:', error);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize global variables
    recordingsList = document.getElementById('recordingsList');
    
    const cameraSelect = document.getElementById('cameraSelect');
    const cameraFeed = document.getElementById('cameraFeed');
    const noCameraMessage = document.getElementById('noCameraMessage');
    const startBtn = document.getElementById('startRecording');
    const stopBtn = document.getElementById('stopRecording');
    const updateSettingsBtn = document.getElementById('updateSettings');
    const recordingStats = document.getElementById('recordingStats');
    const recordingIndicator = document.getElementById('recordingIndicator');
    const fpsCounter = document.getElementById('fpsCounter');
    const motionIndicator = document.getElementById('motionIndicator');
    const refreshRecordingsBtn = document.getElementById('refreshRecordings');
    const resolutionSelect = document.getElementById('resolution');
    const stopCameraBtn = document.getElementById('stopCamera');
    const updateButton = document.getElementById('updateButton');

    // Camera selection
    cameraSelect.addEventListener('change', async () => {
        const cameraId = parseInt(cameraSelect.value);
        if (isNaN(cameraId)) {
            selectedCamera = null;
            cameraFeed.classList.add('d-none');
            noCameraMessage.classList.remove('d-none');
            startBtn.disabled = true;
            stopBtn.disabled = true;
            stopCameraBtn.disabled = true;
            updateSettingsBtn.disabled = true;
            resolutionSelect.disabled = true;
            
            // Clear status update interval
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
                statusUpdateInterval = null;
            }
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/api/camera/select`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ camera_id: cameraId })
            });
            const data = await response.json();
            if (data.status === 'success') {
                selectedCamera = data.camera;
                cameraFeed.src = `${API_BASE_URL}/video_feed?t=${Date.now()}`; // Add timestamp to prevent caching
                cameraFeed.classList.remove('d-none');
                noCameraMessage.classList.add('d-none');
                startBtn.disabled = false;
                stopBtn.disabled = false;
                stopCameraBtn.disabled = false;
                updateSettingsBtn.disabled = false;
                resolutionSelect.disabled = false;

                // Set current resolution in dropdown
                const [width, height] = selectedCamera.resolution;
                const resolutionOption = `${width},${height}`;
                if ([...resolutionSelect.options].some(opt => opt.value === resolutionOption)) {
                    resolutionSelect.value = resolutionOption;
                } else {
                    const option = new Option(`${width}x${height}`, resolutionOption);
                    resolutionSelect.add(option);
                    resolutionSelect.value = resolutionOption;
                }
                
                // Start status updates
                if (statusUpdateInterval) {
                    clearInterval(statusUpdateInterval);
                }
                updateCameraStatus();  // Initial update
                statusUpdateInterval = setInterval(updateCameraStatus, 1000);  // Update every second
            }
        } catch (error) {
            console.error('Error selecting camera:', error);
            alert('Failed to initialize camera');
        }
    });

    // Recording controls
    startBtn.addEventListener('click', async () => {
        try {
            const response = await fetch(`${API_BASE_URL}/api/camera/record/start`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();
            if (data.status === 'success') {
                startBtn.disabled = true;
                stopBtn.disabled = false;
                recordingIndicator.classList.remove('d-none');
                recordingStats.classList.remove('d-none');
                recordingStartTime = Date.now();
                
                // Start recording duration counter
                recordingInterval = setInterval(() => {
                    const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
                    const minutes = Math.floor(duration / 60);
                    const seconds = duration % 60;
                    document.getElementById('recordingDuration').textContent = 
                        `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            }
        } catch (error) {
            console.error('Error starting recording:', error);
            alert('Failed to start recording');
        }
    });

    stopBtn.addEventListener('click', async () => {
        try {
            const response = await fetch(`${API_BASE_URL}/api/camera/record/stop`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();
            if (data.status === 'success' || data.path) {
                startBtn.disabled = false;
                stopBtn.disabled = true;
                recordingIndicator.classList.add('d-none');
                recordingStats.classList.add('d-none');
                clearInterval(recordingInterval);
                loadRecordings();  // Refresh recordings list
            } else {
                console.error('Failed to stop recording:', data);
                alert('Failed to stop recording');
            }
        } catch (error) {
            console.error('Error stopping recording:', error);
            alert('Failed to stop recording');
        }
    });

    // Camera settings
    updateSettingsBtn.addEventListener('click', async () => {
        const resolution = resolutionSelect.value.split(',').map(Number);
        try {
            const response = await fetch(`${API_BASE_URL}/api/camera/settings`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    resolution: resolution
                })
            });
            const data = await response.json();
            if (data.status === 'success') {
                // Reload video feed with new settings
                cameraFeed.src = `${API_BASE_URL}/video_feed?t=${Date.now()}`;
            }
        } catch (error) {
            console.error('Error updating settings:', error);
        }
    });

    // Add stop camera handler
    stopCameraBtn.addEventListener('click', async () => {
        try {
            const response = await fetch(`${API_BASE_URL}/api/camera/stop`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();
            if (data.status === 'success') {
                selectedCamera = null;
                cameraFeed.classList.add('d-none');
                noCameraMessage.classList.remove('d-none');
                startBtn.disabled = true;
                stopBtn.disabled = true;
                stopCameraBtn.disabled = true;
                updateSettingsBtn.disabled = true;
                resolutionSelect.disabled = true;
                cameraSelect.value = '';  // Reset camera selection
            } else {
                console.error('Failed to stop camera:', data);
                alert('Failed to stop camera');
            }
        } catch (error) {
            console.error('Error stopping camera:', error);
            alert('Error stopping camera');
        }
    });

    // Load initial recordings
    loadRecordings();
    
    refreshRecordingsBtn.addEventListener('click', loadRecordings);

    // Update system button
    updateButton.addEventListener('click', async function() {
        if (confirm('Are you sure you want to update the system? The application will need to be restarted.')) {
            try {
                const response = await fetch('/api/system/update', {
                    method: 'POST',
                });
                const data = await response.json();
                alert(data.message);
            } catch (error) {
                alert('Update failed: ' + error.message);
            }
        }
    });
});
</script>

<style>
.video-container {
    position: relative;
    width: 100%;
    padding-top: 75%; /* 4:3 Aspect Ratio */
    overflow: hidden;
}

.video-container img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.recording-indicator {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
}

.recording-indicator .badge {
    font-size: 1rem;
    padding: 0.5rem 1rem;
}

.status-indicators .badge {
    font-size: 0.9rem;
}

#noCameraMessage {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
}

.system-controls {
    margin: 20px;
    padding: 10px;
    border-top: 1px solid #eee;
}
</style>
{% endblock %} 