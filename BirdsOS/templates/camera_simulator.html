{% extends "base.html" %}

{% block title %}Camera Simulator{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Camera Feed</h5>
                    <div class="status-indicators">
                        <span id="fpsCounter" class="badge bg-info me-2">0 FPS</span>
                        <span id="motionIndicator" class="badge bg-secondary">No Motion</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="video-container">
                        <img src="{{ url_for('video_feed') }}" class="img-fluid" alt="Camera Feed">
                        <div id="recordingIndicator" class="recording-indicator d-none">
                            <span class="badge bg-danger">REC</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">Recording Controls</h5>
                </div>
                <div class="card-body">
                    <button id="startRecording" class="btn btn-primary mb-2 w-100">Start Recording</button>
                    <button id="stopRecording" class="btn btn-danger mb-2 w-100" disabled>Stop Recording</button>
                    <div class="recording-stats mt-2 d-none" id="recordingStats">
                        <small class="text-muted">
                            Duration: <span id="recordingDuration">0:00</span><br>
                            Frames: <span id="frameCount">0</span>
                        </small>
                    </div>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">Camera Settings</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="resolution" class="form-label">Resolution</label>
                        <select id="resolution" class="form-select mb-2">
                            <option value="640,480">640x480</option>
                            <option value="1280,720">1280x720</option>
                            <option value="1920,1080">1920x1080</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="testPattern" class="form-label">Test Pattern</label>
                        <select id="testPattern" class="form-select mb-2">
                            <option value="grid">Grid</option>
                            <option value="circles">Circles</option>
                            <option value="color_bars">Color Bars</option>
                        </select>
                    </div>
                    <button id="updateSettings" class="btn btn-secondary w-100">Update Settings</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Recent Recordings</h5>
                    <button class="btn btn-sm btn-outline-secondary" id="refreshRecordings">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div id="recordingsList" class="list-group">
                        <!-- Recordings will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables and functions
let recordingsList;
let recordingStartTime = null;
let recordingInterval = null;

// Load recordings function (globally accessible)
async function loadRecordings() {
    try {
        const response = await fetch('/api/camera/recordings');
        const data = await response.json();
        recordingsList.innerHTML = data.map(recording => `
            <div class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${recording.timestamp}</h6>
                    <small>${recording.size}</small>
                </div>
                <p class="mb-1">Duration: ${recording.duration}</p>
                <div class="btn-group btn-group-sm">
                    <a href="/api/camera/recordings/${recording.id}/download" class="btn btn-outline-primary">Download</a>
                    <button class="btn btn-outline-danger" onclick="deleteRecording('${recording.id}')">Delete</button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading recordings:', error);
    }
}

// Delete recording function (globally accessible)
async function deleteRecording(recordingId) {
    if (!confirm('Are you sure you want to delete this recording?')) {
        return;
    }
    try {
        const response = await fetch(`/api/camera/recordings/${recordingId}`, {
            method: 'DELETE'
        });
        const data = await response.json();
        if (data.status === 'success') {
            loadRecordings();  // Refresh the list
        } else {
            alert('Failed to delete recording');
        }
    } catch (error) {
        console.error('Error deleting recording:', error);
        alert('Error deleting recording');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize global variables
    recordingsList = document.getElementById('recordingsList');
    
    const startBtn = document.getElementById('startRecording');
    const stopBtn = document.getElementById('stopRecording');
    const updateSettingsBtn = document.getElementById('updateSettings');
    const recordingStats = document.getElementById('recordingStats');
    const recordingIndicator = document.getElementById('recordingIndicator');
    const fpsCounter = document.getElementById('fpsCounter');
    const motionIndicator = document.getElementById('motionIndicator');
    const refreshRecordingsBtn = document.getElementById('refreshRecordings');

    // Recording controls
    startBtn.addEventListener('click', async () => {
        try {
            const response = await fetch('/api/camera/record/start', {
                method: 'POST'
            });
            const data = await response.json();
            if (data.status === 'success') {
                startBtn.disabled = true;
                stopBtn.disabled = false;
                recordingIndicator.classList.remove('d-none');
                recordingStats.classList.remove('d-none');
                recordingStartTime = Date.now();
                
                // Start recording duration counter
                recordingInterval = setInterval(() => {
                    const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
                    const minutes = Math.floor(duration / 60);
                    const seconds = duration % 60;
                    document.getElementById('recordingDuration').textContent = 
                        `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            }
        } catch (error) {
            console.error('Error starting recording:', error);
        }
    });

    stopBtn.addEventListener('click', async () => {
        try {
            const response = await fetch('/api/camera/record/stop', {
                method: 'POST'
            });
            const data = await response.json();
            if (data.status === 'success') {
                startBtn.disabled = false;
                stopBtn.disabled = true;
                recordingIndicator.classList.add('d-none');
                recordingStats.classList.add('d-none');
                clearInterval(recordingInterval);
                loadRecordings();
            }
        } catch (error) {
            console.error('Error stopping recording:', error);
        }
    });

    // Camera settings
    updateSettingsBtn.addEventListener('click', async () => {
        const resolution = document.getElementById('resolution').value.split(',').map(Number);
        const pattern = document.getElementById('testPattern').value;
        try {
            const response = await fetch('/api/camera/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    resolution: resolution,
                    pattern: pattern
                })
            });
            const data = await response.json();
            if (data.status === 'success') {
                location.reload();
            }
        } catch (error) {
            console.error('Error updating settings:', error);
        }
    });

    // Load recordings
    loadRecordings();

    // Update FPS counter and motion indicator
    setInterval(async () => {
        try {
            const response = await fetch('/api/camera/status');
            const data = await response.json();
            fpsCounter.textContent = `${data.fps.toFixed(1)} FPS`;
            
            if (data.motion_detected) {
                motionIndicator.textContent = 'Motion Detected';
                motionIndicator.classList.remove('bg-secondary');
                motionIndicator.classList.add('bg-success');
            } else {
                motionIndicator.textContent = 'No Motion';
                motionIndicator.classList.remove('bg-success');
                motionIndicator.classList.add('bg-secondary');
            }
        } catch (error) {
            console.error('Error updating status:', error);
        }
    }, 1000);

    refreshRecordingsBtn.addEventListener('click', loadRecordings);
});
</script>

<style>
.video-container {
    position: relative;
    width: 100%;
    padding-top: 75%; /* 4:3 Aspect Ratio */
    overflow: hidden;
}

.video-container img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.recording-indicator {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
}

.recording-indicator .badge {
    font-size: 1rem;
    padding: 0.5rem 1rem;
}

.status-indicators .badge {
    font-size: 0.9rem;
}
</style>
{% endblock %} 