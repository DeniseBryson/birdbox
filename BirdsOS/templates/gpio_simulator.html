{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">GPIO Simulator</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Pin Status -->
                        <div class="col-md-6">
                            <h6>Pin Status</h6>
                            <div class="gpio-grid" id="pinStatus">
                                <!-- Pins will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Controls -->
                        <div class="col-md-6">
                            <h6>Controls</h6>
                            <div class="mb-3">
                                <label class="form-label">Trigger Input Pin</label>
                                <div class="input-group">
                                    <select class="form-select" id="inputPin">
                                        <option value="24">Pin 24 (Optical Gate 1)</option>
                                        <option value="25">Pin 25 (Optical Gate 2)</option>
                                    </select>
                                    <button class="btn btn-primary" onclick="triggerInput(1)">HIGH</button>
                                    <button class="btn btn-secondary" onclick="triggerInput(0)">LOW</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Log Output -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h6>Event Log</h6>
                            <div class="gpio-log" id="gpioLog">
                                <!-- Log entries will be added here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.gpio-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin: 10px 0;
}

.pin-status {
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.pin-status .indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-left: 10px;
}

.pin-status .indicator.high {
    background-color: #28a745;
}

.pin-status .indicator.low {
    background-color: #dc3545;
}

.gpio-log {
    height: 200px;
    overflow-y: auto;
    background-color: #f8f9fa;
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.9em;
}

.log-entry {
    margin: 2px 0;
    padding: 2px 0;
    border-bottom: 1px solid #eee;
}

.log-entry.info { color: #0d6efd; }
.log-entry.error { color: #dc3545; }
</style>
{% endblock %}

{% block extra_js %}
<script>
const MONITORED_PINS = {
    18: "Motor 1",
    23: "Motor 2",
    24: "Optical Gate 1",
    25: "Optical Gate 2"
};

// Update pin status every second
setInterval(updatePinStatus, 1000);

async function updatePinStatus() {
    try {
        const response = await fetch('/api/gpio/status');
        const data = await response.json();
        
        const pinStatus = document.getElementById('pinStatus');
        pinStatus.innerHTML = '';
        
        for (const [pin, name] of Object.entries(MONITORED_PINS)) {
            const status = data.pins[pin] || { state: 'not setup', mode: 'unknown' };
            const div = document.createElement('div');
            div.className = 'pin-status';
            div.innerHTML = `
                <div>
                    <strong>GPIO ${pin}</strong><br>
                    <small>${name} (${status.mode})</small>
                </div>
                <div class="indicator ${status.state === 1 ? 'high' : 'low'}"></div>
            `;
            pinStatus.appendChild(div);
        }
    } catch (error) {
        console.error('Error updating pin status:', error);
    }
}

async function triggerInput(state) {
    const pin = document.getElementById('inputPin').value;
    try {
        const response = await fetch('/api/gpio/trigger', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                pin: parseInt(pin),
                state: state
            })
        });
        const data = await response.json();
        if (data.status === 'success') {
            addLogEntry(`Triggered pin ${pin} to ${state ? 'HIGH' : 'LOW'}`, 'info');
            updatePinStatus();
        } else {
            addLogEntry(`Error triggering pin ${pin}: ${data.message}`, 'error');
        }
    } catch (error) {
        addLogEntry(`Error: ${error.message}`, 'error');
    }
}

function addLogEntry(message, type = 'info') {
    const log = document.getElementById('gpioLog');
    const entry = document.createElement('div');
    entry.className = `log-entry ${type}`;
    entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    log.insertBefore(entry, log.firstChild);
}

// Initial update
updatePinStatus();
</script>
{% endblock %} 